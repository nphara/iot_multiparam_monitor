<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Monitoramento de Saúde em Tempo Real</title>
    <script src="/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
        header { background-color: #007bff; color: #fff; padding: 20px; text-align: center; display: flex; align-items: center; justify-content: center; }
        main { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background-color: #fff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .card h2 { margin: 0; font-size: 1.5em; color: #333; }
        .value { font-size: 2em; color: #007bff; }
        .chart-container { position: relative; width: 100%; height: 50vh; max-width: 1000px; margin: 0 auto; }
        footer { text-align: center; padding: 10px; background-color: #007bff; color: #fff; position: fixed; width: 100%; bottom: 0; }
        canvas { width: 100% !important; height: auto !important; }
        .switch-container { display: flex; justify-content: center; margin-bottom: 20px; gap: 20px; }
        .switch { position: relative; display: inline-block; width: 100px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; border-radius: 50%; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #007bff; }
        input:checked + .slider:before { transform: translateX(66px); }
        .switch-label { margin: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .switch-label span { margin-left: 10px; font-size: 1.2em; color: #333; }
        .slider-container { margin-bottom: 20px; display: flex; justify-content: center; align-items: center; }
        .slider-container label { font-size: 1.2em; color: #333; margin-right: 10px; }
        .slider-container input[type="range"] { width: 300px; }
    </style>
</head>
<body>
    <header><h1>Monitoramento de Saúde em Tempo Real</h1></header>
    <main>
        <div class="switch-container">
            <label class="switch">
                <input type="checkbox" id="max30102">
                <span class="slider"></span>
            </label>
            <label class="switch-label" for="max30102">
                <span>SpO2</span>
            </label>
            <label class="switch">
                <input type="checkbox" id="ad8232">
                <span class="slider"></span>
            </label>
            <label class="switch-label" for="ad8232">
                <span>ECG</span>
            </label>
        </div>
        <div class="slider-container">
            <label for="time-window-slider">Tempo da Janela de Amostra:</label>
            <input type="range" id="time-window-slider" min="1" max="20" value="10">
            <span id="time-window-value">10s</span>
        </div>
        <div class="card"><h2>SpO2</h2><div class="value" id="spo2-value">--</div><p>%</p></div>
        <div class="card"><h2>FC</h2><div class="value" id="hr-value">--</div><p>bpm</p></div>
        <div class="card"><h2>Gráfico de ECG</h2><div class="chart-container"><canvas id="ecg-chart"></canvas></div></div>
    </main>
    <script>
        const ctx = document.getElementById('ecg-chart').getContext('2d');
        let maxDataPoints = 20;
        const ecgChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Leitura do ECG',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                scales: {
                    x: { display: true, title: { display: true, text: 'Tempo' } },
                    y: { display: true, title: { display: true, text: 'Valor' } }
                }
            }
        });
    
        let oximeterInterval = null;
        let ecgInterval = null;
    
        function updateChart(ecgData) {
            const now = new Date().toLocaleTimeString();
            if (ecgChart.data.labels.length >= maxDataPoints) {
                ecgChart.data.labels.shift();
                ecgChart.data.datasets[0].data.shift();
            }
            ecgChart.data.labels.push(now);
            ecgChart.data.datasets[0].data.push(ecgData);
            ecgChart.update();
        }
    
        function startDataCollection() {
            if (document.getElementById('max30102').checked) {
                if (!oximeterInterval) {
                    console.log("Starting SpO2 and FC data collection...");
                    oximeterInterval = setInterval(() => {
                        fetch('/max30102-data')
                            .then(response => response.json())
                            .then(data => {
                                console.log("SpO2/FC data:", data);
                                if (data.SpO2 !== undefined && data.HR !== undefined) {
                                    document.getElementById('spo2-value').innerText = data.SpO2.toFixed(2);
                                    document.getElementById('hr-value').innerText = data.HR.toFixed(2);
                                }
                            })
                            .catch(error => console.error('Error fetching SpO2/FC data:', error));
                    }, 1000);
                }
            } else {
                if (oximeterInterval) {
                    clearInterval(oximeterInterval);
                    oximeterInterval = null;
                    document.getElementById('spo2-value').innerText = '--';
                    document.getElementById('hr-value').innerText = '--';
                }
            }
    
            if (document.getElementById('ad8232').checked) {
                if (!ecgInterval) {
                    console.log("Starting ECG data collection...");
                    ecgInterval = setInterval(() => {
                        fetch('/ad8232-data')
                            .then(response => response.json())
                            .then(data => {
                                console.log("ECG data:", data);
                                if (data.ecg !== undefined) {
                                    updateChart(data.ecg);  // Ensure `data.ecg` is passed here
                                }
                            })
                            .catch(error => console.error('Error fetching ECG data:', error));
                    }, 5);
                }
            } else {
                if (ecgInterval) {
                    clearInterval(ecgInterval);
                    ecgInterval = null;
                }
            }
        }
    
        document.getElementById('max30102').addEventListener('change', startDataCollection);
        document.getElementById('ad8232').addEventListener('change', startDataCollection);
    
        document.getElementById('time-window-slider').addEventListener('input', function () {
            const windowValue = this.value;
            document.getElementById('time-window-value').innerText = `${windowValue}s`;
            maxDataPoints = windowValue;
            ecgChart.data.labels = [];
            ecgChart.data.datasets[0].data = [];
            ecgChart.update();
        });
    </script>
</body>
</html>
